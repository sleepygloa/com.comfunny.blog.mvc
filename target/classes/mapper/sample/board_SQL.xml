<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="board">
	
	<select id="selectBoardList" parameterType="hashmap" resultType="hashmap">
	
	SELECT 
			IDX
		, 	TITLE
		, 	CONTENT
		, 	PASSWD
		, 	WRITER
		,	EMAIL
		, 	REG_DATE
		, 	REF
		, 	RE_LEVEL	
		, 	RE_STEP
		, 	READCOUNT
		, 	@rownum:=@rownum+1 AS r  
	FROM 
			BL_BD
		,	(select @rownum:=0) r
    WHERE   DEL_GB = 'N'
    ORDER BY IDX desc
        
	</select>
	
	 <insert id="insertBoard" parameterType="hashmap" useGeneratedKeys="true" keyProperty="IDX">
		<selectKey keyProperty="IDX" resultType="string" order="BEFORE">
			SELECT MAX(IDX)+1 FROM BL_BD
		</selectKey>
		<![CDATA[
			INSERT INTO BL_BD
			(
				
			    TITLE, 
			    CONTENT, 
			    READCOUNT, 
			    DEL_GB, 
			    REG_DATE, 
			    WRITER
			)
			VALUES
			(
			
				#{title},
				#{content},
			    0, 
			    'N', 
			    now(), 
			    #{writer}
			)
		]]>
	</insert>
	
	<update id="updateHitCnt" parameterType="hashmap">
		<![CDATA[
			UPDATE BL_BD 
			SET
				READCOUNT = IFNULL(READCOUNT, 0) + 1
			WHERE
				IDX = #{IDX}	
		]]>
	</update>
	
	
	<select id="selectBoardDetail" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				IDX,
				READCOUNT,
				WRITER,
				REG_DATE,
				TITLE,
				CONTENT
			FROM
				BL_BD
			WHERE
				IDX = #{IDX}		
		]]>
	</select>
	
	<update id="updateBoard" parameterType="hashmap">
		<![CDATA[
			UPDATE BL_BD 
			SET
				TITLE = #{TITLE},
				CONTENT = #{CONTENT}
			WHERE
				IDX = #{IDX}	
		]]>
	</update>
	
	<update id="deleteBoard" parameterType="hashmap">
		<![CDATA[
			UPDATE BL_BD
			SET
				DEL_GB = 'Y'
			WHERE
				IDX = #{IDX}
		]]>
	</update>
	
	<insert id="insertFile" parameterType="hashmap">
		<![CDATA[
			INSERT INTO BL_BD_FILE
			(
				IDX,
				BOARD_IDX,
				ORIGINAL_FILE_NAME,
				STORED_FILE_NAME,
				FILE_SIZE,
			    REG_DATE,
				WRITER
			)
			VALUES
			(
				#{idx},
				#{BOARD_IDX},
				#{ORIGINAL_FILE_NAME},
				#{STORED_FILE_NAME},
				#{FILE_SIZE},
				now(),
				#{writer}
			)
		]]>
	</insert>
	
	<select id="selectFileList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
			    IDX,
			    ORIGINAL_FILE_NAME,
			    ROUND(FILE_SIZE/1024,1) AS FILE_SIZE
			FROM
			    BL_BD_FILE
			WHERE
			    BOARD_IDX = #{idx}
			    AND DEL_GB = 'N'
		]]>
	</select>
	
	<update id="deleteFileList" parameterType="hashmap">
		<![CDATA[
			UPDATE BL_BD_FILE SET 
				DEL_GB = 'Y' 
			WHERE 
				BOARD_IDX = #{idx}	
		]]>
	</update>
	
	<update id="updateFile" parameterType="hashmap">
		<![CDATA[
			UPDATE BL_BD_FILE SET
				DEL_GB = 'N'
			WHERE
				IDX = #{file_idx}	
		]]>
	</update> 
</mapper>